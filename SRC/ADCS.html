<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>AD is crazy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- FONT -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #000000;
      --panel: rgba(255, 255, 255, 0.03);
      --border: rgba(255, 255, 255, 0.06);
      --text: #cfd6ff;
      --muted: #7d85a6;
      --accent: #5b7cfa;
    }

    body {
      margin: 60px auto;
      width: 75%;
      background: radial-gradient(circle at 20% 10%, #000000, var(--bg));
      color: var(--text);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 14px;
    }

    #h2 {
      margin-top: 0;
    }

    #asci {
      font-size: 4px;
      line-height: 1;
      /* Mantém o espaçamento vertical correto */
      margin: 0;
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    b {
      color: red;
    }

    section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 24px;
      margin-top: 32px;
    }

  </style>
</head>

<body>
  <main>

    <center>
      <pre id="asci">
⠀⠀⠀⢠⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡄⠀⠀⠀
⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀
⢀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⡀
⠘⡀⠀⢸⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⡇⠀⢀⠇
⠀⣧⠀⢸⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⡇⠀⣼⠀
⠀⢸⣆⠀⣿⣷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⣿⠀⣰⡏⠀
⢱⡀⢿⣆⠸⣿⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⣿⡏⣰⡿⠀⡌
⠀⢷⡈⢿⣧⣻⣿⣧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⣿⣟⣴⡿⢁⡾⠀
⢀⠈⢷⣌⢿⣿⣿⣿⣷⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣾⣿⣿⣿⡿⣡⡾⠁⡀
⠀⠳⡈⢻⣦⡻⣿⣿⣿⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣿⣿⣿⣿⣟⣵⡟⢁⠞⠀
⠀⠀⠙⢦⡹⣿⣿⣿⣿⣿⣿⣿⣶⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣶⣿⣿⣿⣿⣿⣿⣿⢏⣴⠋⠀⠀
⠀⠀⠀⡈⠻⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⣴⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⠟⢁⠀⠀⠀
⠀⠀⠀⠈⠢⣌⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣶⣤⣄⣀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣠⣤⣶⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⣡⠔⠁⠀⠀⠀
⠀⠀⠀⠀⢀⠈⠛⢶⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⢰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡷⠛⠁⡀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠉⠒⠦⣬⣛⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠀⠀⠀⠀⠀⠀⠀⠀⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣛⣥⠴⠒⠉⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠠⠤⢤⣌⣉⣛⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣛⣉⣡⡤⠤⠄⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣀⣀⣀⣀⣉⣭⣭⣽⣿⣿⣿⣿⣿⣿⣿⣿⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠹⣿⣿⣿⣿⣿⣿⣿⣿⣯⣭⣭⣉⣀⣀⣀⣀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⢉⣉⣭⣽⣿⣿⣿⣿⣿⣿⣿⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣭⣉⣉⠉⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠒⠒⠛⠛⠛⠛⢛⣩⣿⣿⣿⣿⣿⣿⣿⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⣿⣿⣿⣿⣿⣿⣭⡛⠛⠛⠛⠛⠒⠒⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠤⠴⠾⠟⠛⣫⣿⣿⣿⣿⣿⣿⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⣿⣿⣿⣿⣿⣿⣿⣝⠛⠻⠷⠦⠤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣤⠶⠟⠛⣫⣿⣿⣿⣿⣿⣿⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⣰⣿⣿⣿⣿⣿⣿⣿⣝⠛⠻⠶⢤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡤⠾⠛⣡⣿⣿⣿⣿⣿⣿⣿⡀⠀⠀⠀⠀⠀⠀⢀⣿⣿⣿⣿⣿⣿⢿⣎⠛⠷⢤⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠚⠋⢀⠿⠋⡿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⢿⠙⠿⡄⠙⠓⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⣿⣿⡇⠀⠀⠀⠀⠀⠀⢸⣿⣿⠇⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢻⣿⡇⠀⠀⠀⠀⠀⠀⢸⣿⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⡇⠀⠀⠀⠀⠀⠀⢸⣿⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⡇⠀⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢻⡇⠀⠀⠀⠀⠀⠀⢸⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⢸⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    </pre>
    </center>
    <section>


      <h2 id="h2">What are AD CS and certificates?</h2>
      <p>Serviços de Certificados do Active Directory, certificados são documentos eletrônicos assinados em formato
        <b>X.509</b> que podem ser usados para criptografia, assinatura de mensagens e/ou autenticação (nosso foco).
        As informações incluídas em um certificado vinculam uma identidade (o sujeito) a um par de chaves
        <b>pública/privada.</b> Uma aplicação pode então usar o par de chaves nas operações como prova da identidade do
        usuário. As Autoridades Certificadoras (CAs) são responsáveis pela emissão dos certificados.
      </p>
      <br>
      <h3>Termos e siglas</h3>
      <li>PKI: (Infraestrutura de Chave Pública) — um sistema para gerenciar certificados/criptografia de chave pública
      </li>
      <br>
      <li>AD CS: (Active Directory Certificate Services) — Implementação PKI da Microsoft</li>
      <br>
      <li>CA: (Autoridade Certificadora) — servidor PKI que emite certificados</li>
      <br>
      <li>Enterprise CA: A CA integrada com AD (em vez de uma CA independente) oferece modelos de certificado</li>
      <br>
      <li>Certificate template: uma coleção de configurações e políticas que define o conteúdo de um certificado emitido
        por uma CA empresarial</li>
      <br>
      <li>CSR: (Solicitação de Assinatura de Certificado) — uma mensagem enviada a uma CA para solicitar um certificado
        assinado</li>
      <br>
      <li>EKU: (Uso de Chaves Estendido/Aprimorado) — um ou mais identificadores de objeto (OIDs) que definem como um
        certificado pode ser usado</li>

      <br>
      <br>

      <h2>Overview</h2>
      <p>Em um nível geral, os clientes geram um par de chaves público-privadas, e a chave pública é colocada em uma
        mensagem de solicitação de assinatura de certificado (CSR) junto com outros detalhes, como o assunto do
        certificado e o nome do modelo de certificado.
        Os clientes então enviam o CSR para o servidor da CA Empresarial. O servidor de CA então verifica se o cliente
        pode solicitar certificados. Se sim, ele determina se emitirá um certificado pesquisando o modelo de certificado
        objeto AD especificado no CSR. A CA verificará se as permissões do objeto AD do modelo de certificado permitem
        que
        a conta autenticante obtenha um certificado.
        Se sim, a CA gera um certificado usando as configurações de "blueprint" definidas pelo modelo de certificado
        (por
        exemplo, EKUs, configurações de criptografia, requisitos de emissão, etc.) e usando as outras informações
        fornecidas no CSR, se permitido pelas configurações do modelo do certificado. A CA assina o certificado usando
        sua
        chave privada e depois o devolve ao cliente.
      </p>
      <br>
      <center>
        <img src="adcs.png" alt="adcs" width="73%">
        <p>Figura 1</p>
      </center>
      <br>
      <br>
      <h32>Subject Alternative Names <b>(SAN)</b></h32>
      <p>SAN pode ser descartada no contexto de persitência de conta, porém é essencial para entender outros ataques de
        AD
        CS, por isso irei deixar a explicação do que seria SAN em si.</p>
      <p>Subject Alternative Name (SAN) é uma extensão de certificados <b>X.509 que permite associar identidades
          adicionais ao certificado além do Subject.</b> Em certificados TLS, isso é amplamente utilizado para suportar
        múltiplos domínios com um único certificado. Entretanto, quando certificados contendo EKUs de autenticação (como
        Client Authentication ou Smart Card Logon) são emitidos por uma infraestrutura AD CS mal configurada, a extensão
        SAN pode introduzir um vetor crítico de escalonamento de privilégios.
        Em determinados cenários de autenticação baseada em certificados como <b>Kerberos PKINIT ou Schannel o Domain
          Controller pode mapear o certificado apresentado a uma conta do Active Directory com base em um UPN
          especificado
          na SAN.</b>
      <p>Caso um template de certificado permita que solicitantes não privilegiados forneçam arbitrariamente o conteúdo
        da
        SAN (por exemplo, através da flag <b>ENROLLEE_SUPPLIES_SUBJECT_ALT_NAME)</b>, e a CA não valide se o solicitante
        é
        o legítimo proprietário do UPN informado, um atacante pode obter um certificado válido que será aceito pelo
        domínio como pertencente à conta alvo.</p>
      <p>Esse tipo de misconfiguração em templates do AD CS pode resultar em autenticação como usuários de maior
        privilégio, caracterizando um vetor de escalonamento de privilégios em domínio.</p>
      <br>
      <center><img src="SAN.png" alt="san" width="74%"></center>
      </p>
      <br>
      <br>
      <h2>Persistência de Conta</h2>
      <p>Com os conceitos de AD CS e Subject Alternative Name (SAN) em mente, é possível estabelecer persistência de
        identidade abusando de certificados emitidos por uma CA empresarial mal configurada.</p>
      <p>Em ambientes com Active Directory Certificate Services, usuários ou contas de máquina podem solicitar
        certificados a partir de templates para os quais possuam permissão de <b>enrollment</b>. No contexto de roubo e
        persistência de credenciais, o objetivo é identificar templates que emitam certificados com EKUs compatíveis com
        autenticação no domínio (como Client Authentication ou Smart Card Logon).</p>
      <br>
      <p>Certify pode ser utilizada para enumerar templates potencialmente relevantes:<br>
        <br>
        <b>Certify.exe find /clientauth</b>
      </p>
      <p>Esse comando consulta o LDAP em busca de templates que suportem autenticação, permitindo uma triagem inicial.
      </p>
      <img src="certify.png" alt="" width="63%">
      <br>
      <br>
      <p>Isso também pode ser feito via PSPKIAudit com:
        <br>
        <br>
        <b>Get-AuditCertificateTemplate | ?{ $_. HasAuthenticationEku}</b>
      </p>
      <img src="pspkai.png" alt="" width="63%">
      <br>
      <br>
      <p>Caso o atacante possua acesso a uma interface gráfica, a solicitação de certificados pode ser realizada via
        <b>MMC (certlm.msc ou snap-in de Certificates)</b>. Em cenários não interativos, ferramentas como Certify ou
        certreq.exe podem ser utilizadas para realizar inscrições maliciosas.
      </p>
      <img src="certify2.png" alt="" width="61%">
      <P>Se o template permitir que o solicitante controle o Subject ou a SAN (por exemplo, através da flag
        <b>ENROLLEE_SUPPLIES_SUBJECT_ALT_NAME</b>) e a CA não validar a propriedade do UPN informado, o atacante pode
        obter um certificado válido associado a outra identidade do domínio.
      </P>
      <P>Os certificados emitidos podem então ser utilizados com o Rubeus para autenticação baseada em certificados via
        PKINIT, permitindo acesso ao Active Directory como o usuário alvo enquanto o certificado permanecer válido. <br>
        <b>Esse método fornece persistência de longo prazo, não envolve acesso ao LSASS e pode ser realizado sem
          privilégios elevados, dependendo das permissões do template.</b>
      </P>
      <br>
        <center><p>AD CS is very good.</p>
      <p>by Leonardo Kauan - krnl</p>
    </section>
  </main>

</body>


</html>

